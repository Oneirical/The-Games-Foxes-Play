<!DOCTYPE html>
<title>The Games Foxes Play</title>

<style>
    canvas{
        outline: 1px solid white;
    }

    body{
        background-color: black;
        text-align: center;
        margin-top: 50px;
    }
    @font-face {
    font-family: 'Visitor';
    src: url("visitor4.ttf");
    }
</style>

<canvas></canvas>
<script src="js/game.js"></script>
<script src="js/map.js"></script>
<script src="js/tile.js"></script>
<script src="js/monster.js"></script>
<script src="js/util.js"></script>
<script src="js/soul.js"></script>
<script src="js/text.js"></script>
<script src="js/world.js"></script>
<script src="js/ui.js"></script>
<script src="js/loot.js"></script>
<script src="js/rooms.js"></script>
<script>

    mousepos = [0,0];
    spritesheet = new Image();
    spritesheet.src = 'textures/spritesheet.png';
    spritesheet.onload = showTitle;

    invsheet = new Image();
    invsheet.src = 'textures/inventorysheet.png';

    mapsheet = new Image();
    mapsheet.src = 'textures/mapsheet.png';

    rosefilter = new Image();
    rosefilter.src = 'textures/rosefilter.png';

    cyanfilter = new Image();
    cyanfilter.src = 'textures/cyanfilter.png';

    blackfilter = new Image();
    blackfilter.src = 'textures/blackfilter.png';
                             
    gameState = "loading";  

    startingHp = 6;
    maxHp = 6;
    var exitspawn;
    var player;

    victory = false;

    uiWidth = 6;
    uiHeight = 4;
    level = 1;

    dontremove = [];

    tileSize = 64;
    numTiles = 9;
    area = "Faith";
 
    cursormode = false;
    invmode = false;
    numLevels = 17;
    doublecounter = 0;
    dialoguecount = 0;
    fail = false;
    fallen = false;
    areachange = true;
    spirevisited = false;
    showboss = false;

    shakeAmount = 0;       
    shakeX = 0;                 
    shakeY = 0;
    rolled = 0;
    sacrifice = 0;
    sacritotal = "nan";
    currentspelldesc = "nan";
    falseagony = false;
    rerolled = false;
    inInventory = false;
    inModules = false;

    naiamode = false;
    contemhint = false;
    inMap = false;
    rosetoxin = 0;

    resolvebonus = 0;

    currenttrack = "none";

    var spirespawner;
    

    document.querySelector("html").onkeypress = function(e){
        if(gameState == "title"){                              
            startGame();                
        }else if(gameState == "dead"){                             
            showTitle();                                      
        }else if(gameState == "running"){
            if (e.key == "l"){
                inInventory = !inInventory;
            }
            if (e.key == "m"){
                inMap = !inMap;
            }
            if (inInventory){
                if (e.key >= 1 && e.key <= 6) legendaries.storeSoul(e.key-1);
                if (e.key >= 7 && e.key <= 9) legendaries.activateSoul(e.key-7);
                if (e.key == 0) legendaries.activateSoul(3);
            }
            if (inInventory || inModules) return;
            if(e.key=="c") {
                cursormode = !cursormode;
                invmode = false;
                currentspelldesc = "nan";
            } 
            if (e.key == "o"){ //debug
                legendaries.activateSoul(0,legendaries.storage[0]);
            }
            if (e.key == "t"){ //debug
                legendaries.storeSoul(0, legendaries.active[0]);
            }
            if(e.key=="c"&&cursormode) cursor = new Cursor(playerTile());
            if(e.key=="c"&&!cursormode) cursor.die();
            if(e.key=="w"&&!cursormode && player.para == 0 && player.fall <= 1 && !player.constrict) player.tryMove(0, -1);
            else if(e.key=="s"&&!cursormode && player.para == 0&& player.fall <= 1 && !player.constrict) player.tryMove(0, 1);
            else if(e.key=="a"&&!cursormode && player.para == 0&& player.fall <= 1 && !player.constrict) player.tryMove(-1, 0);
            else if(e.key=="d"&&!cursormode && player.para == 0&& player.fall <= 1 && !player.constrict) player.tryMove(1, 0);
            else if((e.key=="w"||e.key=="s"||e.key=="a"||e.key=="d") && player.para != 0) {
                player.para--;
                tick();
            }
            else if((e.key=="w"||e.key=="s"||e.key=="a"||e.key=="d") && player.constrict) {
                let neighbours = player.tile.getAdjacentNeighbors();
                let check = true;
                for (let i of neighbours){
                    if(i.monster instanceof Apis){
                        check = false;
                    }
                }
                if (check){
                    if(e.key=="w"&&!cursormode && player.para == 0 && player.fall <= 1) player.tryMove(0, -1);
                    else if(e.key=="s"&&!cursormode && player.para == 0&& player.fall <= 1) player.tryMove(0, 1);
                    else if(e.key=="a"&&!cursormode && player.para == 0&& player.fall <= 1) player.tryMove(-1, 0);
                    else if(e.key=="d"&&!cursormode && player.para == 0&& player.fall <= 1) player.tryMove(1, 0);
                    player.constrict = false;
                    //log.addLog("Empty");
                } 
                else{
                    if(e.key=="w"&&!cursormode && player.para == 0 && player.fall <= 1 && player.tile.getNeighbor(0, -1).monster) player.tryMove(0, -1);
                    else if(e.key=="s"&&!cursormode && player.para == 0&& player.fall <= 1 && player.tile.getNeighbor(0, 1).monster) player.tryMove(0, 1);
                    else if(e.key=="a"&&!cursormode && player.para == 0&& player.fall <= 1 && player.tile.getNeighbor(-1, 0).monster) player.tryMove(-1, 0);
                    else if(e.key=="d"&&!cursormode && player.para == 0&& player.fall <= 1 && player.tile.getNeighbor(1, 0).monster) player.tryMove(1, 0);
                    else if (player.dead) tick();
                } 
            }
            else if((e.key=="w"||e.key=="s"||e.key=="a"||e.key=="d") && player.fall > 1) {
                //tick();
                if (e.key == "a"){
                    player.tryMove(-1, 0);
                }
                else if (e.key == "d"){
                    player.tryMove(1, 0);
                }
                else if (e.key == "w" && (player.tile.getNeighbor(0, -1).monster || player.entranced)){
                    player.tryMove(0, -1);
                }
                else if (e.key == "s" && (player.tile.getNeighbor(0, 1).monster|| player.entranced)){
                    player.tryMove(0, 1);
                    if (player.tile.getNeighbor(0, 1).monster) player.tile.getNeighbor(0, 1).monster.knockback(1, [0,1]);
                }
                let tile = getTile(player.tile.x,player.tile.y+1);
                if (player.fall > 0) player.move(tile);
                if (player.tile.y > 8 || player.tile.x > 8 || player.tile.x < 0 || player.tile.y < 0){
                    player.hit(99);
                    player.sprite = 83;
                    fallen = true;
                    log.addLog("Fallen");
                    tick();
                }
                if (player.tile.y > 8){
                    player.hit(99);
                }
                if(player.tile.getNeighbor(0,1) instanceof Platform || player.tile.getNeighbor(0,1) instanceof Ladder || player.tile.getNeighbor(0,1) instanceof Booster) {
                    player.fall = 0;
                }
                if(player.activemodule == "Hover") player.fall = 0;
            }
            if(e.key=="w"&&cursormode) cursor.tryMove(0, -1);
            if(e.key=="s"&&cursormode) cursor.tryMove(0, 1);
            if(e.key=="a"&&cursormode) cursor.tryMove(-1, 0);
            if(e.key=="d"&&cursormode) cursor.tryMove(1, 0);
            if(e.key>=1 && e.key<=9 && !cursormode && player.para == 0) wheel.castSoul(e.key-1);
            if(e.key>=1 && e.key<=9 && cursormode && invmode) currentspelldesc = e.key-1;
            if(e.key=="f" && cursormode && invmode) currentspelldesc = player.activemodule;
            if(e.key=="q" && !cursormode && player.para == 0) wheel.drawSoul();//player.drawSpell();
            if(e.key=="v" && cursormode && invmode && cursor.tile.monster.teleportCounter <= 0) currentspelldesc = cursor.tile.monster.loot;
            if(e.key=="f" && gameState == "running" && !cursormode) log.addLog("WIP");//player.cycleModules();
            if(e.key=="p") cursor.debug();
            
        }else if(gameState == "contemplation"){
            if(e.key>=1 && e.key<=9 && !cursormode && player.para == 0) wheel.castSoul(e.key-1);
            if(e.key=="q" && !falseagony){
                //log.addLog("Empty");
                player.revivify();
            }
        }else if(gameState == "vision"){
            if(e.key>=1 && e.key<=9 && player.discarded > 0){
                player.discardSpell(e.key-1);
                player.discarded--;
            } 
            else if(e.key>=1 && e.key<=9 && player.discarded == 0) player.stackSpell(e.key-1);
        }else if (gameState == "discard"){
            if(e.key=="w"&&!cursormode) player.tryMove(0, -1);
            else if(e.key=="s"&&!cursormode) player.tryMove(0, 1);
            else if(e.key=="a"&&!cursormode) player.tryMove(-1, 0);
            else if(e.key=="d"&&!cursormode) player.tryMove(1, 0);
            if (e.key>=1 && e.key<=9){
                wheel.discardSoul(e.key-1);
            }
            else if (e.key == "q") wheel.endDiscard();
        }
    };

    setInterval(draw, 15);

    setupCanvas();

    initSounds();
</script>